<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>í…ŒìŠ¤íŠ¸ ë²¤ì¹˜ - Project Zero Retail App</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f1f5f9;
            display: block;
            overflow-y: auto;
        }

        .test-header {
            background: #fff;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            padding: 3rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .product-card {
            background: #fff;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            transition: transform 0.2s;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-img {
            height: 200px;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #94a3b8;
        }

        .product-info {
            padding: 1.5rem;
        }

        .price {
            font-size: 1.25rem;
            font-weight: 700;
            color: #0f172a;
        }

        /* ë²„ê·¸ ìœ ë°œ ìŠ¤íƒ€ì¼ë“¤ */
        .bug-overflow {
            white-space: nowrap;
            overflow: visible;
            width: 100px;
            color: red;
            font-weight: 800;
            border: 2px dashed red;
        }

        /* ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë²„ê·¸ */
        .bug-hidden-btn {
            opacity: 0;
            pointer-events: none;
        }

        /* ë²„íŠ¼ ì•ˆëˆŒë¦¼ ë²„ê·¸ */
        .bug-wrong-calc {
            color: #dc2626;
            text-decoration: line-through;
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }

        /* ê°€ê²© ê³„ì‚° ì˜¤ë¥˜ ì‹œê°í™” */

        /* ê²°í•¨ ë³´ê³  í”Œë¡œíŒ… ë²„íŠ¼ */
        .report-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #2563eb;
            color: #fff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
            z-index: 1000;
            transition: transform 0.2s;
        }

        .report-fab:hover {
            transform: scale(1.1);
        }

        .report-tooltip {
            position: fixed;
            bottom: 5.5rem;
            right: 2rem;
            background: #1e293b;
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
        }

        .report-fab:hover+.report-tooltip {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="test-header">
        <div class="store-name"
            style="font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
            <i class="fas fa-shopping-cart" style="color: #2563eb;"></i>
            ZeroStore Online
        </div>
        <div style="display: flex; align-items: center; gap: 1.5rem;">
            <div style="color: #64748b; font-size: 0.875rem; font-weight: 500;">
                <i class="fas fa-shield-halved"></i> QA Sandbox Mode
            </div>
            <button class="btn btn-primary"
                style="background: #ef4444; border: none; padding: 0.6rem 1.2rem; display: flex; align-items: center; gap: 0.5rem;"
                onclick="openRegister()">
                <i class="fas fa-plus-circle"></i> ì‹ ê·œ ê²°í•¨ ë“±ë¡
            </button>
        </div>
    </div>

    <div
        style="background: #fff; padding: 1.5rem; text-align: center; border-bottom: 1px solid #e2e8f0; box-shadow: 0 4px 12px -5px rgba(0,0,0,0.05);">
        <h1 style="font-size: 1.5rem; color: #1e293b; margin-bottom: 0.5rem;">ì‡¼í•‘ëª° ë©”ì¸ ìƒí’ˆ ëª©ë¡</h1>
        <p
            style="color: #475569; font-size: 0.95rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            <i class="fas fa-circle-info" style="color: #3b82f6;"></i>
            <strong>QA ì•ˆë‚´:</strong> ë³¸ í™”ë©´ì€ í…ŒìŠ¤íŠ¸ìš© ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤. ìƒë‹¨ í˜¹ì€ í•˜ë‹¨ì˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°œê²¬í•œ ê²°í•¨ì„ ë“±ë¡í•´ ì£¼ì„¸ìš”.
        </p>
    </div>

    <div class="product-grid">
        <!-- ì •ìƒ ìƒí’ˆ -->
        <div class="product-card">
            <div class="product-img">ğŸ</div>
            <div class="product-info">
                <h3>ìœ ê¸°ë† ì‚¬ê³¼ ì„¸íŠ¸</h3>
                <p style="color: #64748b; margin: 0.5rem 0;">ì‹ ì„ í•œ ê²½ë¶ ì‚¬ê³¼ 10kg</p>
                <div class="price">55,000ì›</div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
            </div>
        </div>

        <!-- ë²„ê·¸ ìƒí’ˆ 1: ë ˆì´ì•„ì›ƒ í…ìŠ¤íŠ¸ ì˜¤ë²„í”Œë¡œìš° -->
        <div class="product-card">
            <div class="product-img">ğŸ±</div>
            <div class="product-info">
                <h3>í”„ë¦¬ë¯¸ì—„ ë„ì‹œë½ ì„¸íŠ¸ (ê°€ì •ìš©/í”¼í¬ë‹‰ìš©/ë‹¨ì²´ì£¼ë¬¸í™˜ì˜)</h3>
                <p class="bug-overflow">ì´ í…ìŠ¤íŠ¸ëŠ” ë„ˆë¬´ ê¸¸ì–´ì„œ ë ˆì´ì•„ì›ƒì„ ëš«ê³  ë‚˜ê°€ëŠ” ì‹¬ê°í•œ UI ê²°í•¨ì´ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="price">12,000ì›</div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;">êµ¬ë§¤í•˜ê¸°</button>
            </div>
        </div>

        <!-- ë²„ê·¸ ìƒí’ˆ 2: ê¸°ëŠ¥ ì˜¤ë¥˜ (ë²„íŠ¼ ì‚¬ë¼ì§/ì•ˆëˆŒë¦¼) -->
        <div class="product-card">
            <div class="product-img">ğŸ§Š</div>
            <div class="product-info">
                <h3>ì´ˆì •ë°€ ëƒ‰ë™ê³ </h3>
                <p style="color: #64748b; margin: 0.5rem 0;">ì˜í•˜ 80ë„ ìœ ì§€ ìŠ¤ë§ˆíŠ¸ ê°€ì „</p>
                <div class="price">2,450,000ì›</div>
                <button class="btn btn-primary bug-hidden-btn" style="width: 100%; margin-top: 1rem;">í’ˆì ˆ (í´ë¦­
                    ë¶ˆê°€)</button>
            </div>
        </div>

        <!-- ë²„ê·¸ ìƒí’ˆ 3: ë°ì´í„°/ê°€ê²© ê³„ì‚° ì˜¤ë¥˜ -->
        <div class="product-card">
            <div class="product-img">ğŸ§</div>
            <div class="product-info">
                <h3>ë…¸ì´ì¦ˆ ìº”ìŠ¬ë§ í—¤ë“œì…‹</h3>
                <p style="color: #64748b; margin: 0.5rem 0;">ìµœê³ ì˜ ëª°ì…ê°ì„ ì„ ì‚¬í•©ë‹ˆë‹¤.</p>
                <div class="price">
                    <span class="bug-wrong-calc">350,000ì›</span>
                    <span style="color: #2563eb;">0ì› (???)</span>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;">ì´ë“ë³´ê¸°</button>
            </div>
        </div>
    </div>

    <div class="report-fab" id="openReport">
        <i class="fas fa-bug"></i>
    </div>
    <div class="report-tooltip">ë°œê²¬í•œ ê²°í•¨ ë“±ë¡í•˜ê¸°</div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        async function openRegister() {
            // 1. í™”ë©´ ìº¡ì²˜ ë° ì •ë³´ ìˆ˜ì§‘ ì¤€ë¹„
            const btn = document.querySelector('.test-header .btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìº¡ì²˜ ì¤‘...';

            // 2. íŒì—…ì„ ë¨¼ì € ì—´ì–´ë‘  (ë¹„ë™ê¸° ì‘ì—… í›„ window.open ì°¨ë‹¨ ë°©ì§€)
            const width = 1100;
            const height = 900;
            const left = (window.screen.width / 2) - (width / 2);
            const top = (window.screen.height / 2) - (height / 2);

            const popup = window.open('about:blank', 'DefectRegister',
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);

            if (!popup) {
                alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
                btn.innerHTML = originalText;
                return;
            }

            // UI ì•ˆì •í™”ë¥¼ ìœ„í•œ ì¶©ë¶„í•œ ëŒ€ê¸°
            await new Promise(r => setTimeout(r, 300));

            let screenshot = '';

            // html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
            if (typeof html2canvas !== 'undefined') {
                try {
                    const canvas = await html2canvas(document.body, {
                        logging: false,
                        useCORS: true,
                        allowTaint: false,
                        scale: 1, // ìŠ¤ì¼€ì¼ì„ 1ë¡œ ê³ ì •í•˜ì—¬ ì•ˆì •ì„± í™•ë³´
                        backgroundColor: '#f1f5f9',
                        removeContainer: true,
                        ignoreElements: (el) => {
                            try {
                                return el.classList && (
                                    el.classList.contains('report-fab') ||
                                    el.classList.contains('report-tooltip') ||
                                    el.classList.contains('fa-spinner')
                                );
                            } catch (e) { return false; }
                        }
                    });

                    screenshot = canvas.toDataURL('image/jpeg', 0.5);
                    console.log("[TestBench] Screen captured successfully.");
                } catch (err) {
                    console.error("[TestBench] Capture failed:", err);
                }
            } else {
                console.error("[TestBench] html2canvas library is not loaded.");
            }

            try {
                // ì •ë³´ ì¶”ì¶œ
                const storeName = document.querySelector('.store-name')?.innerText.trim() || 'ZeroStore Online';
                const h1Text = document.querySelector('h1')?.innerText.trim() || document.title;

                const defectData = {
                    title: `[í…ŒìŠ¤íŠ¸ë²¤ì¹˜] ${h1Text} - ê²°í•¨ ë³´ê³ `,
                    menu_name: storeName,
                    screen_name: h1Text,
                    screen_url: window.location.href,
                    screenshot: screenshot,
                    env_info: `Browser: ${navigator.userAgent}`,
                    test_type: 'í†µí•©í…ŒìŠ¤íŠ¸'
                };

                localStorage.setItem('pending_defect', JSON.stringify(defectData));

                // 3. íŒì—…ì˜ ì£¼ì†Œë¥¼ ì‹¤ì œ ë“±ë¡ í™”ë©´ìœ¼ë¡œ ì´ë™
                popup.location.href = '../index.html?mode=standalone#register';

            } catch (err) {
                console.error("[TestBench] Data processing failed:", err);
                if (popup) popup.close();
                alert('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        document.getElementById('openReport').addEventListener('click', openRegister);
    </script>
</body>

</html>