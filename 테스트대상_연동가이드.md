# DefectFlow Integration Guide (Client-Side Widget)

이 가이드는 테스트 대상인 웹사이트에 **'결함 등록 버튼(Widget)'**을 추가하여, 테스트 중에 즉시 결함을 보고할 수 있도록 설정하는 방법을 설명합니다. 특히 최근 강화된 **보안 로그인** 및 **실시간 화면 캡처** 연동 방식을 포함하고 있습니다.

*   **관리 도구 URL**: [https://mohenz.github.io/defect_manage/](https://mohenz.github.io/defect_manage/)
*   **연동 예시 페이지**: [https://mohenz.github.io/defect_manage/test_view/test_view.html](https://mohenz.github.io/defect_manage/test_view/test_view.html)

---

## 1. 최신 연동 스크립트 (Recommended)

아래 스크립트는 `html2canvas`를 사용하여 현재 화면을 즉시 캡처하고, 결함 정보를 관리 시스템으로 자동 전달합니다. 테스트 대상 웹사이트의 `</body>` 태그 바로 위에 삽입하세요.

```html
<!-- DefectFlow Report Widget -->
<div id="defectflow-widget-container"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
(function() {
    const DEFECTFLOW_URL = "https://mohenz.github.io/defect_manage/"; 

    // 1. 아이콘 로딩 (FontAwesome)
    if (!document.querySelector('link[href*="font-awesome"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(link);
    }

    // 2. 위젯 스타일 정의
    const style = document.createElement('style');
    style.innerHTML = `
        #defectflow-report-btn {
            position: fixed; bottom: 30px; right: 30px; z-index: 99999;
            width: 65px; height: 65px; border-radius: 50%;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white; border: none; cursor: pointer;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.5);
            display: flex; align-items: center; justify-content: center;
            font-size: 26px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #defectflow-report-btn:hover { transform: scale(1.1) rotate(10deg); }
        #defectflow-report-btn .tooltip { 
            position: absolute; right: 80px; background: #1e293b; color: white;
            padding: 8px 15px; border-radius: 8px; font-size: 14px; font-weight: 600;
            white-space: nowrap; visibility: hidden; opacity: 0; transition: 0.3s;
        }
        #defectflow-report-btn:hover .tooltip { visibility: visible; opacity: 1; right: 85px; }
    `;
    document.head.appendChild(style);

    // 3. 버튼 생성
    const btn = document.createElement('button');
    btn.id = 'defectflow-report-btn';
    btn.innerHTML = '<i class="fas fa-bug"></i><span class="tooltip">결함 발견! 리포트 하기</span>';
    
    btn.onclick = async function() {
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
            // 화면 캡처 수행
            const canvas = await html2canvas(document.body, { useCORS: true, logging: false });
            const screenshot = canvas.toDataURL('image/jpeg', 0.6);

            // 데이터 구성
            const defectData = {
                title: `[${document.title}] 결함 보고`,
                menu_name: "운영/테스트 사이트",
                screen_name: document.title,
                screen_url: window.location.href,
                screenshot: screenshot,
                env_info: `Browser: ${navigator.userAgent}`,
                test_type: "사용자 테스트"
            };

            // LocalStorage에 임시 저장 (동일 도메인인 경우 활용 가능)
            localStorage.setItem('pending_defect', JSON.stringify(defectData));

            // 등록 창 열기 (Standalone 모드)
            const width = 1100, height = 900;
            const left = (window.screen.width / 2) - (width / 2);
            const top = (window.screen.height / 2) - (height / 2);
            
            // 필수: URL 파라미터 순서 준수 (mode=standalone이 hash 앞에 와야 함)
            window.open(
                `${DEFECTFLOW_URL}?mode=standalone#register`, 
                'DefectFlowRegister', 
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        } catch (e) {
            console.error("Capture failed", e);
            alert("캡처 중 오류가 발생했습니다.");
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    };
    document.body.appendChild(btn);
})();
</script>
```

---

## 2. 주요 연동 포인트 및 변경 사항

### 2.1 URL 구조 (중요)
관리 시스템이 팝업('Standalone')임을 인식하고 사이드바를 숨기기 위해서는 파라미터 순서가 매우 중요합니다.
*   **Correct**: `index.html?mode=standalone#register`
*   **Incorrect**: `index.html#register?mode=standalone` (동작하지 않음)

### 2.2 보안 및 로그인 흐름
*   위젯을 통해 창이 열릴 때 **로그인이 되어 있지 않으면 자동으로 로그인 화면**으로 이동합니다.
*   로그인 완료 후에는 다른 페이지로 튕기지 않고, **원래 요청했던 결함 등록 화면으로 자동 복구**되어 캡처 데이터가 유지됩니다.

### 2.3 데이터 연동 (LocalStorage)
*   위젯은 현재 사이트의 `localStorage`에 `pending_defect`라는 키로 데이터를 저장합니다.
*   **주의**: 테스트 대상 사이트와 관리 시스템의 **도메인이 다른 경우**, 위젯의 스크립트만으로는 `screenshot` 전달이 제한될 수 있습니다. 이 경우 URL 파라미터나 PostMessage 방식을 고려해야 하나, 현재 시스템은 보안상 **동일 도메인 연동** 또는 **이미지 직접 업로드**를 권장합니다.

---

## 3. 작동 단계
1.  **클릭**: 위젯 버튼을 누르면 즉시 현재 브라우저 화면이 캡처됩니다.
2.  **보정**: 페이지의 URL, 제목, User Agent가 자동으로 수집됩니다.
3.  **오픈**: 전용 팝업 창이 열리며, 관리 시스템으로 데이터가 전송됩니다.
4.  **완료**: 로그인 상태 확인 후, 모든 정보가 입력된 등록 폼이 나타납니다.

---

## 4. 커스터마이징 가이드
*   `test_type`: 스크립트 내에서 `단위테스트`, `통합테스트` 등으로 기본값을 변경할 수 있습니다.
*   `screenshot`: 캡처 기능을 끄고 싶다면 `screenshot: ""`로 설정하십시오.

